<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./js/spark-md5.min.js"></script>
    <script src="./js/axios.js"></script>
    <style>
        .topBox{text-align: center;padding: 80px;}
    </style>
</head>
<body>
    <div class="topBox"> 
        <input type="file" class="isInput">
    </div>

    <script>
        let service = null
        initAxios()
        let isInput = document.querySelector('.isInput')
        let unit = 1024*1024*5  //每个切片的大小定位5m
        // 输入框change事件
        isInput.onchange = function(e) {
            let userId = `5421-${new Date().getTime()}` // 用户id,标记数据的唯一性
            let file = e.target.files[0]
            console.log(file,'file')
            let sliceNumber = Math.ceil(file.size/unit)  // 向上取证切割次数,例如20.54,那里就要为了那剩余的0.54再多遍历一次
            let allDatas = []
            for (let i = 0; i < sliceNumber; i++) {
                let sliceFile = file.slice(i*unit,i*unit+unit)
                setMd5(sliceFile).then((res)=>{
                    let needObj = {
                        file:res,
                        sliceFileSize:sliceFile.size,
                        index:i,
                        fileSize:file.size,
                        fileName:file.name,
                        sliceNumber,
                        userId,
                    }
                    allDatas.push(needObj)  // 放到一个数组里,预防其中一个请求断了
                    console.log(allDatas,'里边')
                    upload(needObj,(progress)=>{
                        console.log(Math.round(progress.loaded / progress.total * 100) + '%')
                    }).then((res)=>{
                        console.log(res.data,'返回响应数据')  
                    }).catch((err)=>{
                        console.log(err)
                    })
                })
            }
        }
        // 上传接口
        function upload(data,onUploadProgress){
            return service({url:'/updata',method:'post',data,onUploadProgress})
        }
        // md5加密
        function setMd5(file){
            return new Promise((resolve,reject)=>{
                let sparkMD52 = new SparkMD5.ArrayBuffer()
                let reader = new FileReader()
                reader.readAsArrayBuffer(file)
                reader.onload = (event) => {
                  let str = event.target.result
                  sparkMD52.append(str)
                  let md = sparkMD52.end() 
                  resolve(md)
                }
                reader.onerror = (err) => {
                    reject(err)
                }
            })
        }
        // 初始化axios
        function initAxios(){
            // const { protocol, hostname, port } = window.location // location对象里的协议地址端口
            // let baseUrl = protocol + '//' + hostname + (port ? ':' + port : '')
            let baseUrl = 'http://192.168.56.1:3000'
            service = axios.create({
              baseURL: baseUrl, // 请求头
              timeout: 15000 // 请求超时时间
            })
        }
    </script>
</body>
</html>