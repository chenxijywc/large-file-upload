<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./js/spark-md5.min.js"></script>
    <script src="./js/axios.js"></script>
    <style>
        .topBox{text-align: center;padding: 80px;}
    </style>
</head>
<body>
    <div class="topBox"> 
        <input type="file" class="isInput">
    </div>

    <script>
        let service = null
        initAxios()
        let isInput = document.querySelector('.isInput')
        let unit = 1024*1024*5  //每个切片的大小定位5m
        isInput.onchange = function(e) {
            let userId = `5421-${new Date().getTime()}` // 用户id,标记数据的唯一性
            let file = e.target.files[0]
            console.log(file,'file')
            let sliceNumber = Math.ceil(file.size/unit)  // 向上取证切割次数,例如20.54,那里就要为了那剩余的0.54再多遍历一次
            let allFormData = []
            for (let i = 0; i < sliceNumber; i++) {
                let sliceFile = file.slice(i*unit,i*unit+unit)
                setMd5(sliceFile).then((res)=>{
                    let fd = new FormData()
                    fd.append('file',res)
                    fd.append('sliceFileSize',sliceFile.size)
                    fd.append('index',i)
                    fd.append('fileSize',file.size)
                    fd.append('fileName',file.name)
                    fd.append('sliceNumber',sliceNumber)
                    fd.append('userId',userId)
                    allFormData.push(fd)  // 放到一个数组里,预防其中一个请求断了
                    // for (let [a, b] of fd.entries()) { console.log(`${a}: ${b}`) }
                    console.log(allFormData,'里边')
                    // upload(fd,(progress)=>{
                    //     console.log(Math.round(progress.loaded / progress.total * 100) + '%')
                    // }).then((res)=>{
                         
                    // }).catch((err)=>{
                    //     console.log(err)
                    // })
                })
            }
        }
        // 上传接口
        function upload(data,onUploadProgress){
            service({url:'./123',method:'post',data,onUploadProgress})
        }
        // md5加密
        function setMd5(file){
            return new Promise((resolve,reject)=>{
                let sparkMD52 = new SparkMD5.ArrayBuffer()
                let reader = new FileReader()
                reader.readAsArrayBuffer(file)
                reader.onload = (event) => {
                  let str = event.target.result
                  sparkMD52.append(str)
                  let md = sparkMD52.end() 
                  resolve(md)
                }
                reader.onerror = (err) => {
                    reject(err)
                }
            })
        }
        // 初始化axios
        function initAxios(){
            const { protocol, hostname, port } = window.location // location对象里的协议地址端口
            let baseUrl = protocol + '//' + hostname + (port ? ':' + port : '')
            service = axios.create({
              baseURL: baseUrl, // 请求头
              timeout: 15000 // 请求超时时间
            })
        }
    </script>
</body>
</html>